<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- FullCalendar -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<style>
:root {
    --bg-1: #f5f7fb;
    --bg-2: #e9edf7;
    --ink: #14213d;
    --muted: #5b6787;
    --side-1: #0b132b;
    --side-2: #1c2541;
    --accent: #2d6cdf;
    --line: #dfe5f1;
    --card: #ffffff;
}

body {
    margin: 0;
    font-family: 'Space Grotesk', sans-serif;
    background:
        radial-gradient(circle at 18% 22%, #ffffff 0%, rgba(255,255,255,0) 35%),
        radial-gradient(circle at 82% 2%, #edf2ff 0%, rgba(237,242,255,0) 28%),
        linear-gradient(120deg, var(--bg-1), var(--bg-2));
    color: var(--ink);
}

/* ===== LAYOUT ===== */
.layout { display: flex; }

/* ===== SIDEBAR ===== */
.sidebar {
    width: 78px;
    background: linear-gradient(175deg, var(--side-1), var(--side-2));
    color: white;
    height: 100vh;
    position: fixed;
    transition: width 0.3s ease;
    overflow: hidden;
    box-shadow: 10px 0 30px rgba(3, 7, 18, 0.2);
    border-right: 1px solid rgba(148, 163, 184, 0.2);
}
.sidebar.expanded { width: 260px; }

.sidebar-header {
    padding: 18px;
    text-align: center;
    cursor: pointer;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    background: rgba(255, 255, 255, 0.04);
}

.sidebar-profile {
    margin: 12px 10px 8px 10px;
    border: 1px solid rgba(148, 163, 184, 0.22);
    background: rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #5c9dff, #2d6cdf);
    color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
    box-shadow: 0 6px 14px rgba(31, 90, 204, 0.3);
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.sidebar-profile-meta {
    min-width: 0;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.sidebar.expanded .sidebar-profile-meta {
    opacity: 1;
}

.sidebar-profile-meta .name {
    color: #eef2ff;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sidebar-profile-meta .dept {
    color: #b9c6ef;
    font-size: 11px;
}

.sidebar a {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #d8e1ff;
    padding: 14px 18px;
    margin: 8px 10px;
    border-radius: 12px;
    transition: 0.22s ease;
    white-space: nowrap;
}
.sidebar a:hover {
    background: rgba(89, 134, 255, 0.2);
    color: white;
}
.sidebar a.active {
    background: linear-gradient(90deg, rgba(45,108,223,0.85), rgba(84,122,255,0.95));
    color: #fff;
    box-shadow: 0 8px 20px rgba(45,108,223,0.25);
}
.sidebar svg {
    width: 20px;
    height: 20px;
    stroke-width: 2;
    margin-right: 15px;
    min-width: 20px;
}
.sidebar span {
    opacity: 0;
    transition: opacity 0.2s ease;
    font-weight: 500;
}
.sidebar.expanded span { opacity: 1; }

/* ===== MAIN ===== */
.main {
    margin-left: 78px;
    padding: 26px 28px 40px 28px;
    flex: 1;
    transition: margin-left 0.3s ease;
}
.main.shifted { margin-left: 260px; }

.top-bar {
    position: sticky;
    top: 14px;
    z-index: 20;
    margin-bottom: 24px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(8px);
    border-radius: 14px;
    padding: 14px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.06);
}

.top-brand h1 {
    margin: 0;
    font-size: 22px;
    letter-spacing: 0.2px;
}

.top-brand p {
    margin: 2px 0 0 0;
    font-size: 12px;
    color: var(--muted);
}

.top-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #eef4ff;
    color: #1747a6;
    border: 1px solid #cfe0ff;
    border-radius: 999px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
}

.top-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.profile-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px 6px 6px;
    border: 1px solid #d4deee;
    border-radius: 999px;
    background: #fff;
    cursor: pointer;
}

.profile-chip .avatar {
    width: 30px;
    height: 30px;
    font-size: 11px;
}

.profile-chip .meta {
    line-height: 1.1;
}

.profile-chip .meta .name {
    font-size: 12px;
    font-weight: 700;
    color: #1f2937;
}

.profile-chip .meta .role {
    font-size: 10px;
    color: #64748b;
}

/* ===== SECTION CONTROL ===== */
.section { display: none; }
.section.active { display: block; }

/* ===== CARD ===== */
.card {
    background: var(--card);
    padding: 25px;
    border-radius: 14px;
    border: 1px solid var(--line);
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
    margin-bottom: 30px;
}

/* ===== TABLE ===== */
table {
    width: 100%;
    border-collapse: collapse;
}
th {
    background: #f5f7fc;
    padding: 12px;
    font-size: 14px;
    text-align: left;
}
td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
    font-size: 14px;
}

.tt-day-card {
    border: 1px solid #dfe7f6;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 12px;
    background: linear-gradient(180deg, #ffffff, #f9fbff);
    box-shadow: 0 8px 20px rgba(18, 33, 77, 0.04);
}

.tt-day-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
}

.tt-day-head h4 {
    margin: 0;
    color: #182540;
    font-size: 16px;
}

.tt-count {
    font-size: 11px;
    padding: 4px 9px;
    border-radius: 999px;
    background: #e9f0ff;
    color: #1e429f;
    font-weight: 600;
    white-space: nowrap;
}

.tt-list {
    display: grid;
    gap: 8px;
}

.tt-item {
    border: 1px solid #e3e9f5;
    border-radius: 10px;
    padding: 10px 12px;
    background: #fff;
    display: grid;
    grid-template-columns: 58px 1fr;
    align-items: center;
    gap: 10px;
}

.tt-slot {
    border-radius: 8px;
    padding: 6px 0;
    text-align: center;
    font-size: 12px;
    font-weight: 700;
    color: #0f2f74;
    background: #e8f0ff;
}

.tt-subject {
    font-size: 14px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 2px;
}

.tt-meta {
    font-size: 12px;
    color: #4a5a7a;
}

.chip {
    display: inline-block;
    margin-left: 6px;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    background: #fef3c7;
    color: #92400e;
}

.filter-wrap {
    background: #f8fafe;
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 14px;
}

.filter-label {
    font-size: 13px;
    color: #475569;
    margin-bottom: 8px;
    display: block;
}

.filter-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-select {
    min-width: 220px;
    padding: 9px 10px;
    border-radius: 8px;
    border: 1px solid #cfd8eb;
    background: #fff;
    color: #1e293b;
}

.filter-select:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

.filter-btn {
    border: none;
    border-radius: 8px;
    background: #dde6f7;
    color: #1e293b;
    padding: 9px 12px;
    cursor: pointer;
}

.filter-count {
    font-size: 12px;
    color: #334155;
    background: #e7efff;
    border-radius: 30px;
    padding: 4px 10px;
}

.profile-panel {
    display: none;
    position: fixed;
    top: 90px;
    right: 24px;
    width: 280px;
    z-index: 200;
    background: #fff;
    border: 1px solid #dfe5f1;
    border-radius: 12px;
    box-shadow: 0 16px 30px rgba(15, 23, 42, 0.16);
    padding: 14px;
}

.profile-panel.show {
    display: block;
}

.profile-panel h4 {
    margin: 0 0 10px 0;
    font-size: 16px;
}

.profile-row {
    font-size: 13px;
    color: #334155;
    margin: 6px 0;
}

.profile-panel label {
    display: block;
    font-size: 12px;
    color: #475569;
    margin-top: 8px;
}

.profile-panel input,
.profile-panel select {
    width: 100%;
    margin-top: 4px;
    padding: 8px 9px;
    border-radius: 8px;
    border: 1px solid #d2daeb;
}

.profile-panel button {
    margin-top: 10px;
    width: 100%;
    border: none;
    border-radius: 8px;
    background: #2d6cdf;
    color: #fff;
    padding: 9px 10px;
    cursor: pointer;
}

.profile-erp {
    padding: 0;
    overflow: hidden;
}

.profile-hero {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background:
        radial-gradient(circle at 0% 0%, rgba(255,255,255,0.65), rgba(255,255,255,0)),
        linear-gradient(90deg, #edf3ff, #e2ecff);
    border-bottom: 1px solid #d7e3fb;
}

.profile-hero h3 {
    margin: 0;
    font-size: 22px;
}

.profile-hero p {
    margin: 4px 0 0 0;
    color: #4b5f8f;
    font-size: 13px;
}

.profile-main {
    display: grid;
    grid-template-columns: 230px 1fr;
    gap: 18px;
    padding: 18px;
}

.profile-side {
    border: 1px solid #e0e8f6;
    border-radius: 12px;
    background: #f8fbff;
    padding: 14px;
}

.profile-avatar-lg {
    width: 94px;
    height: 94px;
    border-radius: 50%;
    margin: 0 auto 10px auto;
    background: linear-gradient(135deg, #5c9dff, #2d6cdf);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 34px;
    box-shadow: 0 12px 24px rgba(45, 108, 223, 0.25);
    overflow: hidden;
}

.profile-avatar-lg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-side .meta-line {
    font-size: 13px;
    color: #334155;
    margin: 7px 0;
}

.profile-form {
    border: 1px solid #e0e8f6;
    border-radius: 12px;
    background: #fff;
    padding: 14px;
}

.profile-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.profile-form-grid .full {
    grid-column: 1 / -1;
}

.profile-form label {
    display: block;
    font-size: 12px;
    color: #475569;
    margin-bottom: 5px;
}

.profile-form input,
.profile-form select {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #d0dbef;
    font-family: 'Space Grotesk', sans-serif;
    box-sizing: border-box;
}

.profile-form input:focus,
.profile-form select:focus {
    outline: none;
    border-color: #2d6cdf;
    box-shadow: 0 0 0 3px rgba(45,108,223,0.15);
}

.profile-form .submit-btn {
    margin-top: 12px;
    width: 100%;
    border: none;
    border-radius: 10px;
    padding: 11px;
    background: linear-gradient(90deg, #2d6cdf, #4d83f6);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
}

.calendar-event-card {
    margin-top: 14px;
    border: 1px solid #dce6f7;
    border-radius: 12px;
    background: linear-gradient(180deg, #ffffff, #f8fbff);
    padding: 12px;
}

.calendar-event-card h4 {
    margin: 0 0 8px 0;
    font-size: 15px;
    color: #1a2c50;
}

.calendar-event-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 8px;
}

.calendar-event-item {
    border: 1px solid #e1e8f6;
    border-radius: 10px;
    background: #fff;
    padding: 8px 10px;
}

.calendar-event-item .k {
    font-size: 11px;
    color: #64748b;
}

.calendar-event-item .v {
    margin-top: 2px;
    font-size: 13px;
    color: #0f172a;
    font-weight: 600;
}

@media (max-width: 860px) {
    .profile-main {
        grid-template-columns: 1fr;
    }
    .profile-form-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>

<div class="layout">

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">

    <div class="sidebar-header" onclick="toggleSidebar()">
        <i data-lucide="menu"></i>
    </div>

    <div class="sidebar-profile" onclick="openProfileSection(event)">
        <div class="avatar">
            {% if student_profile_pic %}
            <img src="{{ url_for('static', filename=student_profile_pic) }}" alt="Profile">
            {% else %}
            {{ student_name[:1] | upper }}
            {% endif %}
        </div>
        <div class="sidebar-profile-meta">
            <div class="name">{{ student_name }}</div>
            <div class="dept">{{ student_department }} Student</div>
        </div>
    </div>

    <a href="#" class="nav-link active" data-section="dashboard" onclick="showSection('dashboard', this)">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
    </a>

    <a href="#" class="nav-link" data-section="timetable" onclick="showSection('timetable', this)">
        <i data-lucide="calendar"></i>
        <span>My Timetable</span>
    </a>

    <a href="#" class="nav-link" data-section="institute-timetable" onclick="showSection('institute-timetable', this)">
        <i data-lucide="building-2"></i>
        <span>Institute Timetable</span>
    </a>

    <a href="#" class="nav-link" data-section="calendar" onclick="showSection('calendar', this)">
        <i data-lucide="calendar-days"></i>
        <span>Academic Calendar</span>
    </a>

    <a href="/logout">
        <i data-lucide="log-out"></i>
        <span>Logout</span>
    </a>

</div>

<!-- MAIN -->
<div class="main" id="main">

    <div class="top-bar">
        <div class="top-brand">
            <h1>Welcome, {{ student_name }}</h1>
            <p>SmartTimetable Student Workspace</p>
        </div>
        <div class="top-right">
            <div class="top-pill">
                <i data-lucide="graduation-cap"></i>
                {{ student_department }} | Academic Portal
            </div>
            <div class="profile-chip" onclick="openProfileSection(event)">
                <div class="avatar">
                    {% if student_profile_pic %}
                    <img src="{{ url_for('static', filename=student_profile_pic) }}" alt="Profile">
                    {% else %}
                    {{ student_name[:1] | upper }}
                    {% endif %}
                </div>
                <div class="meta">
                    <div class="name">{{ student_name }}</div>
                    <div class="role">Student</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE -->
    <div id="profile" class="section">
        <div class="card profile-erp">
            <div class="profile-hero">
                <div>
                    <h3>My Profile</h3>
                    <p>Manage your student identity and account settings</p>
                </div>
                <div class="top-pill">
                    <i data-lucide="sparkles"></i>
                    Student ERP Profile
                </div>
            </div>

            <div class="profile-main">
                <div class="profile-side">
                    <div class="profile-avatar-lg">
                        {% if student_profile_pic %}
                        <img src="{{ url_for('static', filename=student_profile_pic) }}" alt="Profile">
                        {% else %}
                        {{ student_name[:1] | upper }}
                        {% endif %}
                    </div>
                    <div class="meta-line"><b>Name:</b> {{ student_name }}</div>
                    <div class="meta-line"><b>Email:</b> {{ student_email }}</div>
                    <div class="meta-line"><b>Role:</b> Student</div>
                    <div class="meta-line"><b>Department:</b> {{ student_department }}</div>
                </div>

                <form class="profile-form" action="/profile/update" method="POST" enctype="multipart/form-data">
                    <div class="profile-form-grid">
                        <div class="full">
                            <label>Name</label>
                            <input type="text" name="name" value="{{ student_name }}" required>
                        </div>

                        <div>
                            <label>Department</label>
                            <select name="department">
                                <option {% if student_department == 'ALL' %}selected{% endif %}>ALL</option>
                                <option {% if student_department == 'CSE' %}selected{% endif %}>CSE</option>
                                <option {% if student_department == 'ECE' %}selected{% endif %}>ECE</option>
                                <option {% if student_department == 'IT' %}selected{% endif %}>IT</option>
                                <option {% if student_department == 'ME' %}selected{% endif %}>ME</option>
                            </select>
                        </div>

                        <div>
                            <label>Profile Picture</label>
                            <input type="file" name="profile_pic" accept="image/*">
                        </div>
                    </div>
                    <button class="submit-btn" type="submit">Update Profile</button>
                </form>
            </div>
        </div>
    </div>


    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
        <div class="card">
            <h3>Student Overview</h3>
            <p>
                Access your timetable and academic calendar from the navigation menu.
            </p>
            <p style="color:#334155; margin-top:12px;">
                Department: <b>{{ student_department }}</b>
            </p>
            <p style="color:#334155;">
                Classes in your custom timetable: <b>{{ my_timetable | length }}</b>
            </p>
        </div>

        <div class="card">
            <h3>My Classes Today ({{ today_name }})</h3>
            {% if my_today %}
            <table>
                <thead>
                    <tr>
                        <th>Slot</th>
                        <th>Subject</th>
                        <th>Teacher</th>
                        <th>Room</th>
                        <th>Label</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in my_today %}
                    <tr>
                        <td>{{ row.slot }}</td>
                        <td>{{ row.subject }}</td>
                        <td>{{ row.teacher }}</td>
                        <td>{{ row.room }}</td>
                        <td>{{ row.label if row.label else "-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:#64748b;">No classes today for your branch.</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>Institute Classes Today ({{ today_name }})</h3>
            {% if institute_today %}
            <table>
                <thead>
                    <tr>
                        <th>Slot</th>
                        <th>Subject</th>
                        <th>Teacher</th>
                        <th>Room</th>
                        <th>Target</th>
                        <th>Label</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in institute_today %}
                    <tr>
                        <td>{{ row.slot }}</td>
                        <td>{{ row.subject }}</td>
                        <td>{{ row.teacher }}</td>
                        <td>{{ row.room }}</td>
                        <td>{{ row.target }}</td>
                        <td>{{ row.label if row.label else "-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:#64748b;">No institute classes today.</p>
            {% endif %}
        </div>
    </div>

    <!-- TIMETABLE -->
    <div id="timetable" class="section">
        <div class="card">
            <h3>Your Timetable</h3>

            <div id="myTimetableSummary"></div>
        </div>
    </div>

    <!-- INSTITUTE TIMETABLE -->
    <div id="institute-timetable" class="section">
        <div class="card">
            <h3>Institute Timetable</h3>
            <div class="filter-wrap">
                <label class="filter-label">Filter by Department</label>
                <div class="filter-row">
                    <select id="deptFilter" class="filter-select">
                        <option value="ALL">All Departments</option>
                    </select>
                    <button id="clearDeptFilter" class="filter-btn" type="button">Reset</button>
                    <span id="filterCount" class="filter-count">Showing 0 classes</span>
                </div>
            </div>

            <div id="instituteTimetableSummary"></div>
        </div>
    </div>

    <!-- CALENDAR -->
    <div id="calendar" class="section">
        <div class="card">
            <h3>Academic Calendar</h3>
            <div id="calendarUI"></div>
            <div id="studentEventDetails" class="calendar-event-card">
                <h4>Event Details</h4>
                <div style="font-size:13px; color:#64748b;">Click any event on calendar to view creator and subject details.</div>
            </div>
            <div style="margin-top:14px;">
                <h4 style="margin:0 0 8px 0;">Upcoming Vacations</h4>
                {% if vacations %}
                    {% for v in vacations %}
                    <div style="font-size:13px; color:#334155; margin:4px 0;">
                        {{ v.date }} | {{ v.title }}
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="font-size:13px; color:#64748b;">No vacation events yet.</div>
                {% endif %}
            </div>
        </div>
    </div>

</div>
</div>

<script>

let calendar = null;
let calendarInitialized = false;
const dayOrder = { Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5 };
const slotOrder = { S1: 1, S2: 2, S3: 3, S4: 4 };
const fullDayName = { Mon: "Monday", Tue: "Tuesday", Wed: "Wednesday", Thu: "Thursday", Fri: "Friday" };
const myTimetableRows = {{ my_timetable | tojson }};
const instituteRows = {{ institute_timetable | tojson }};

function sortRows(rows) {
    return rows.slice().sort((a, b) => {
        const d = (dayOrder[a.day] || 99) - (dayOrder[b.day] || 99);
        if (d !== 0) return d;
        return (slotOrder[a.slot] || 99) - (slotOrder[b.slot] || 99);
    });
}

function groupByDay(rows) {
    const groups = {};
    sortRows(rows).forEach(r => {
        if (!groups[r.day]) groups[r.day] = [];
        groups[r.day].push(r);
    });
    return groups;
}

function renderSummary(containerId, rows, type) {
    const container = document.getElementById(containerId);
    if (!rows.length) {
        container.innerHTML = "<p style='color:#64748b;'>No timetable available.</p>";
        return;
    }

    const grouped = groupByDay(rows);
    const orderedDays = Object.keys(grouped).sort((a, b) => (dayOrder[a] || 99) - (dayOrder[b] || 99));
    let html = "";

    orderedDays.forEach(day => {
        const sentence = type === "my"
            ? `On ${fullDayName[day] || day}, in your timetable you have:`
            : `On ${fullDayName[day] || day}, in institute timetable there are:`;

        html += `<div class="tt-day-card">
                    <div class="tt-day-head">
                        <h4>${sentence}</h4>
                        <span class="tt-count">${grouped[day].length} class(es)</span>
                    </div>
                    <div class="tt-list">`;
        grouped[day].forEach(r => {
            const label = r.label ? `<span class="chip">${r.label}</span>` : "";
            const target = type === "institute" ? ` | Dept: ${r.target}` : "";
            html += `<div class="tt-item">
                        <div class="tt-slot">${r.slot}</div>
                        <div>
                            <div class="tt-subject">${r.subject}${label}</div>
                            <div class="tt-meta">${r.teacher} | Room ${r.room}${target}</div>
                        </div>
                    </div>`;
        });
        html += "</div></div>";
    });

    container.innerHTML = html;
}

function initDeptFilter() {
    const filter = document.getElementById("deptFilter");
    const clearBtn = document.getElementById("clearDeptFilter");
    const countTag = document.getElementById("filterCount");
    const depts = [...new Set(instituteRows.map(r => (r.target || "ALL").toUpperCase()))].sort();
    depts.forEach(d => {
        if (d === "ALL") return;
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        filter.appendChild(opt);
    });

    function applyFilter() {
        const val = filter.value;
        const rows = val === "ALL"
            ? instituteRows
            : instituteRows.filter(r => (r.target || "ALL").toUpperCase() === val);
        renderSummary("instituteTimetableSummary", rows, "institute");
        countTag.textContent = `Showing ${rows.length} classes`;
    }

    filter.onchange = applyFilter;
    clearBtn.onclick = () => {
        filter.value = "ALL";
        applyFilter();
    };

    applyFilter();
}

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("expanded");
    document.getElementById("main").classList.toggle("shifted");
}

function showSection(id, el = null) {

    document.querySelectorAll(".section").forEach(sec => {
        sec.classList.remove("active");
    });

    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
    if (el) {
        el.classList.add("active");
    } else {
        const matched = document.querySelector(`.nav-link[data-section="${id}"]`);
        if (matched) matched.classList.add("active");
    }

    if (id === "calendar") {

        if (!calendarInitialized) {

            const calendarEl = document.getElementById('calendarUI');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 650,
                events: '/events',
                eventClick: function(info) {
                    const ext = info.event.extendedProps || {};
                    const subject = ext.subject || info.event.title || "-";
                    const createdBy = ext.creator_name || ext.creator_email || "Unknown";
                    const eventType = ext.type || "general";
                    const priority = ext.important ? "Important" : "Normal";
                    const dateStr = (info.event.startStr || "").slice(0, 10) || "-";
                    const box = document.getElementById("studentEventDetails");
                    box.innerHTML = `
                        <h4>Event Details</h4>
                        <div class="calendar-event-grid">
                            <div class="calendar-event-item"><div class="k">Title</div><div class="v">${info.event.title || "-"}</div></div>
                            <div class="calendar-event-item"><div class="k">Subject</div><div class="v">${subject}</div></div>
                            <div class="calendar-event-item"><div class="k">Created By</div><div class="v">${createdBy}</div></div>
                            <div class="calendar-event-item"><div class="k">Date</div><div class="v">${dateStr}</div></div>
                            <div class="calendar-event-item"><div class="k">Type</div><div class="v">${eventType.toUpperCase()}</div></div>
                            <div class="calendar-event-item"><div class="k">Priority</div><div class="v">${priority}</div></div>
                        </div>
                    `;
                }
            });

            calendar.render();
            calendarInitialized = true;

        } else {
            setTimeout(() => {
                calendar.updateSize();
            }, 150);
        }
    }
}

function openProfileSection(e) {
    if (e) e.preventDefault();
    const profileNav = document.getElementById("profileNavLink");
    showSection("profile", profileNav);
}

lucide.createIcons();
renderSummary("myTimetableSummary", myTimetableRows, "my");
initDeptFilter();

</script>

</body>
</html>
